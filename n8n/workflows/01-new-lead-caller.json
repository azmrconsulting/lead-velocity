{
  "name": "Lead Velocity - New Lead Caller",
  "nodes": [
    {
      "id": "trigger",
      "name": "New Lead Trigger",
      "type": "n8n-nodes-base.googleSheetsTrigger",
      "position": [0, 0],
      "parameters": {
        "documentId": "={{ $env.GOOGLE_SHEETS_ID }}",
        "sheetName": "Leads",
        "event": "rowAdded",
        "pollTimes": {
          "item": [{ "mode": "everyMinute" }]
        }
      },
      "notes": "Triggers when Browse AI adds a new row to the sheet"
    },
    {
      "id": "validate",
      "name": "Validate Lead",
      "type": "n8n-nodes-base.if",
      "position": [200, 0],
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.phone }}",
              "operation": "isNotEmpty"
            },
            {
              "value1": "={{ $json.status }}",
              "value2": "new",
              "operation": "equals"
            },
            {
              "value1": "={{ $json.do_not_contact }}",
              "value2": "TRUE",
              "operation": "notEquals"
            }
          ]
        }
      },
      "notes": "Check: has phone, status=new, not on DNC"
    },
    {
      "id": "check_hours",
      "name": "Check Calling Hours",
      "type": "n8n-nodes-base.code",
      "position": [400, 0],
      "parameters": {
        "jsCode": "// Check if current time is within calling hours\nconst now = new Date();\nconst hour = now.getHours();\nconst day = now.getDay(); // 0=Sun, 6=Sat\n\n// Calling hours: 9am-8pm, Mon-Sat\nconst START_HOUR = 9;\nconst END_HOUR = 20;\nconst VALID_DAYS = [1, 2, 3, 4, 5, 6]; // Mon-Sat\n\nconst isValidHour = hour >= START_HOUR && hour < END_HOUR;\nconst isValidDay = VALID_DAYS.includes(day);\n\nreturn [{\n  json: {\n    ...items[0].json,\n    canCall: isValidHour && isValidDay,\n    currentHour: hour,\n    currentDay: day\n  }\n}];"
      },
      "notes": "Only call during 9am-8pm Mon-Sat"
    },
    {
      "id": "hours_check",
      "name": "Within Hours?",
      "type": "n8n-nodes-base.if",
      "position": [600, 0],
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.canCall }}",
              "value2": true,
              "operation": "equals"
            }
          ]
        }
      }
    },
    {
      "id": "update_status_calling",
      "name": "Update Status to Calling",
      "type": "n8n-nodes-base.googleSheets",
      "position": [800, 0],
      "parameters": {
        "operation": "update",
        "documentId": "={{ $env.GOOGLE_SHEETS_ID }}",
        "sheetName": "Leads",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "status": "calling",
            "call_attempts": "={{ parseInt($json.call_attempts || 0) + 1 }}",
            "last_call_date": "={{ $now.toISOString() }}",
            "updated_at": "={{ $now.toISOString() }}"
          }
        },
        "options": {
          "cellFormat": "USER_ENTERED"
        },
        "matchingColumns": ["id"]
      },
      "notes": "Mark lead as 'calling' before initiating"
    },
    {
      "id": "call_vapi",
      "name": "Initiate Vapi Call",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1000, 0],
      "parameters": {
        "method": "POST",
        "url": "https://api.vapi.ai/call/phone",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.VAPI_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "assistantId",
              "value": "={{ $env.VAPI_ASSISTANT_ID }}"
            },
            {
              "name": "phoneNumberId",
              "value": "={{ $env.VAPI_PHONE_NUMBER_ID }}"
            },
            {
              "name": "customer",
              "value": "={ \"number\": \"{{ $json.phone }}\" }"
            },
            {
              "name": "assistantOverrides",
              "value": "={ \"variableValues\": { \"address\": \"{{ $json.address }}\", \"price\": \"{{ $json.price }}\", \"beds\": \"{{ $json.beds }}\", \"baths\": \"{{ $json.baths }}\", \"sqft\": \"{{ $json.sqft }}\" } }"
            },
            {
              "name": "metadata",
              "value": "={ \"lead_id\": \"{{ $json.id }}\", \"client_id\": \"{{ $json.client_id }}\" }"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "notes": "Call Vapi API to initiate outbound call"
    },
    {
      "id": "save_call_id",
      "name": "Save Vapi Call ID",
      "type": "n8n-nodes-base.googleSheets",
      "position": [1200, 0],
      "parameters": {
        "operation": "update",
        "documentId": "={{ $env.GOOGLE_SHEETS_ID }}",
        "sheetName": "Leads",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "vapi_call_id": "={{ $json.id }}",
            "updated_at": "={{ $now.toISOString() }}"
          }
        },
        "options": {
          "cellFormat": "USER_ENTERED"
        },
        "matchingColumns": ["id"]
      },
      "notes": "Store Vapi call ID for tracking"
    },
    {
      "id": "queue_for_later",
      "name": "Queue for Later",
      "type": "n8n-nodes-base.googleSheets",
      "position": [800, 200],
      "parameters": {
        "operation": "update",
        "documentId": "={{ $env.GOOGLE_SHEETS_ID }}",
        "sheetName": "Leads",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "status": "queued",
            "updated_at": "={{ $now.toISOString() }}"
          }
        },
        "options": {
          "cellFormat": "USER_ENTERED"
        },
        "matchingColumns": ["id"]
      },
      "notes": "Outside calling hours - queue for next valid time"
    },
    {
      "id": "skip_invalid",
      "name": "Skip Invalid Lead",
      "type": "n8n-nodes-base.noOp",
      "position": [400, 200],
      "notes": "Lead failed validation - no action needed"
    }
  ],
  "connections": {
    "New Lead Trigger": {
      "main": [[{ "node": "Validate Lead", "type": "main", "index": 0 }]]
    },
    "Validate Lead": {
      "main": [
        [{ "node": "Check Calling Hours", "type": "main", "index": 0 }],
        [{ "node": "Skip Invalid Lead", "type": "main", "index": 0 }]
      ]
    },
    "Check Calling Hours": {
      "main": [[{ "node": "Within Hours?", "type": "main", "index": 0 }]]
    },
    "Within Hours?": {
      "main": [
        [{ "node": "Update Status to Calling", "type": "main", "index": 0 }],
        [{ "node": "Queue for Later", "type": "main", "index": 0 }]
      ]
    },
    "Update Status to Calling": {
      "main": [[{ "node": "Initiate Vapi Call", "type": "main", "index": 0 }]]
    },
    "Initiate Vapi Call": {
      "main": [[{ "node": "Save Vapi Call ID", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
